<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PulseWeave é«˜çº§æ¼”ç¤ºç•Œé¢</title>
  <style>
    :root { 
      color-scheme: light dark; 
      --primary-color: #2563eb;
      --success-color: #16a34a;
      --warning-color: #d97706;
      --danger-color: #dc2626;
      --bg-card: rgba(255,255,255,0.9);
      --bg-dark: #0b1021;
      --text-light: #e2e8f0;
      --border-color: rgba(0,0,0,0.15);
    }
    
    * { box-sizing: border-box; }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      color: white;
    }
    
    .header h1 { 
      font-size: 28px; 
      margin: 0 0 10px; 
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .header p {
      font-size: 16px;
      opacity: 0.9;
      margin: 0;
    }
    
    .tabs {
      display: flex;
      background: var(--bg-card);
      border-radius: 12px 12px 0 0;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .tab {
      flex: 1;
      padding: 15px 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      background: var(--primary-color);
      color: white;
      border-bottom-color: var(--primary-color);
    }
    
    .tab:hover:not(.active) {
      background: rgba(37, 99, 235, 0.1);
    }
    
    .tab-content {
      background: var(--bg-card);
      border-radius: 0 0 12px 12px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      min-height: 600px;
    }
    
    .tab-pane {
      display: none;
    }
    
    .tab-pane.active {
      display: block;
    }
    
    .card { 
      background: rgba(0,0,0,0.04); 
      padding: 20px; 
      border-radius: 10px; 
      margin-bottom: 20px; 
      border: 1px solid var(--border-color);
    }
    
    .card h3 {
      margin: 0 0 15px;
      font-size: 18px;
      color: var(--primary-color);
    }
    
    label { 
      font-weight: 600; 
      display: block; 
      margin-bottom: 8px; 
      color: #374151;
    }
    
    input[type="text"], input[type="file"], textarea, select { 
      width: 100%; 
      box-sizing: border-box; 
      padding: 12px 15px; 
      border-radius: 8px; 
      border: 2px solid var(--border-color); 
      background: rgba(255,255,255,0.9);
      transition: border-color 0.3s ease;
      font-size: 14px;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    textarea { 
      min-height: 120px; 
      resize: vertical; 
      font-family: inherit;
    }
    
    .btn { 
      padding: 12px 20px; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:disabled { 
      opacity: 0.6; 
      cursor: not-allowed; 
    }
    
    .btn-primary { 
      background: var(--primary-color); 
      color: white; 
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
    }
    
    .btn-success { 
      background: var(--success-color); 
      color: white; 
    }
    
    .btn-warning { 
      background: var(--warning-color); 
      color: white; 
    }
    
    .btn-secondary { 
      background: #64748b; 
      color: white; 
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }
    
    .result { 
      white-space: pre-wrap; 
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; 
      background: var(--bg-dark); 
      color: var(--text-light); 
      padding: 15px; 
      border-radius: 8px; 
      overflow: auto;
      font-size: 13px;
      line-height: 1.5;
    }
    
    .grid {
      display: grid;
      gap: 20px;
    }
    
    .grid-2 {
      grid-template-columns: 1fr 1fr;
    }
    
    .grid-3 {
      grid-template-columns: 1fr 1fr 1fr;
    }
    
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-healthy { background: var(--success-color); }
    .status-warning { background: var(--warning-color); }
    .status-error { background: var(--danger-color); }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(0,0,0,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      transition: width 0.3s ease;
      border-radius: 4px;
    }
    
    .metric-card {
      text-align: center;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary-color), #3b82f6);
      color: white;
      border-radius: 10px;
    }
    
    .metric-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .metric-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .batch-item {
      background: rgba(255,255,255,0.5);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid var(--primary-color);
    }
    
    .batch-item.success {
      border-left-color: var(--success-color);
    }
    
    .batch-item.error {
      border-left-color: var(--danger-color);
    }
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .hidden { display: none !important; }
    
    @media (max-width: 768px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .tabs { flex-direction: column; }
      .btn-group { flex-direction: column; }
      .container { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸŒŠ PulseWeave é«˜çº§æ¼”ç¤ºç•Œé¢</h1>
      <p>æ™ºèƒ½æ¨ç†æœåŠ¡ Â· äº‘ç«¯ä¸æœ¬åœ°èåˆ Â· å®æ—¶åˆ†æä¸æ‰¹é‡å¤„ç†</p>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="single">å•æ–‡æœ¬æ¨ç†</button>
      <button class="tab" data-tab="settings">è®¾ç½®</button>
    </div>

    <div class="tab-content">
      <!-- å•æ–‡æœ¬æ¨ç† -->
      <div class="tab-pane active" id="single">
        <div class="grid grid-2">
          <div>
            <div class="card">
              <h3>ğŸ“ è¾“å…¥æ–‡æœ¬</h3>
              <label>è¯·è¾“å…¥è¦åˆ†æçš„æ–‡æœ¬</label>
              <textarea id="singleText" placeholder="ä¾‹å¦‚ï¼šæ˜æ—©ä¸ƒç‚¹å»æœºåœºï¼Œè®°å¾—èº«ä»½è¯å’Œå……ç”µå®"></textarea>
              
              <label>æ¨ç†æ¨¡å¼</label>
              <select id="inferenceMode">
                <option value="auto">è‡ªåŠ¨é€‰æ‹©</option>
                <option value="cloud">äº‘ç«¯æ¨ç†</option>
                <option value="external">å¤–éƒ¨æä¾›å•†</option>
              </select>
              
              <div class="btn-group">
                <button class="btn btn-primary" id="btnSingleInfer">
                  <span class="loading hidden"></span>
                  å¼€å§‹æ¨ç†
                </button>
                <button class="btn btn-secondary" id="btnSingleClear">æ¸…ç©º</button>
              </div>
            </div>
          </div>
          
          <div>
            <div class="card">
              <h3>ğŸ“Š æ¨ç†ç»“æœ</h3>
              <div class="grid grid-3" id="singleMetrics">
                <div class="metric-card">
                  <div class="metric-value" id="taskType">-</div>
                  <div class="metric-label">ä»»åŠ¡ç±»å‹</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="confidence">-</div>
                  <div class="metric-label">ç½®ä¿¡åº¦</div>
                </div>
                <div class="metric-card">
                  <div class="metric-value" id="latency">-</div>
                  <div class="metric-label">è€—æ—¶(ms)</div>
                </div>
              </div>
            </div>
            
            <div class="card">
              <h3>ğŸ’¡ æ™ºèƒ½å»ºè®®</h3>
              <div id="suggestions">ç­‰å¾…æ¨ç†ç»“æœ...</div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h3>ğŸ” è¯¦ç»†ç»“æœ</h3>
          <pre id="singleResult" class="result">ç­‰å¾…æ¨ç†ç»“æœ...</pre>
        </div>
      </div>

      <!-- æ‰¹é‡æ¨ç† -->
      <div class="tab-pane" id="batch">
        <div class="card">
          <h3>ğŸ“‹ æ‰¹é‡æ–‡æœ¬è¾“å…¥</h3>
          <label>è¾“å…¥å¤šè¡Œæ–‡æœ¬ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
          <textarea id="batchTexts" rows="8" placeholder="æ˜å¤©å¼€ä¼šè®°å¾—å¸¦èµ„æ–™&#10;å‘¨æœ«å»è¶…å¸‚ä¹°èœ&#10;ä¸‹å‘¨ä½“æ£€é¢„çº¦åŒ»é™¢"></textarea>
          
          <div class="grid grid-2">
            <div>
              <label>æ¨ç†æ¨¡å¼</label>
              <select id="batchMode">
                <option value="auto">è‡ªåŠ¨é€‰æ‹©</option>
                <option value="cloud">äº‘ç«¯æ¨ç†</option>
                <option value="external">å¤–éƒ¨æä¾›å•†</option>
              </select>
            </div>
            <div>
              <label>æˆ–ä¸Šä¼ æ–‡ä»¶</label>
              <input type="file" id="batchFile" accept=".txt,.json" />
            </div>
          </div>
          
          <div class="btn-group">
            <button class="btn btn-primary" id="btnBatchInfer">
              <span class="loading hidden"></span>
              æ‰¹é‡æ¨ç†
            </button>
            <button class="btn btn-secondary" id="btnBatchClear">æ¸…ç©º</button>
            <button class="btn btn-success" id="btnExportResults">å¯¼å‡ºç»“æœ</button>
          </div>
        </div>
        
        <div class="card">
          <h3>ğŸ“ˆ æ‰¹é‡è¿›åº¦</h3>
          <div class="progress-bar">
            <div class="progress-fill" id="batchProgress" style="width: 0%"></div>
          </div>
          <div id="batchStatus">å‡†å¤‡å°±ç»ª</div>
        </div>
        
        <div class="card">
          <h3>ğŸ“Š æ‰¹é‡ç»“æœ</h3>
          <div id="batchResults">ç­‰å¾…æ‰¹é‡æ¨ç†...</div>
        </div>
      </div>

      <!-- ç³»ç»Ÿç›‘æ§ -->
      <div class="tab-pane" id="monitor">
        <div class="grid grid-2">
          <div class="card">
            <h3>ğŸ¥ ç³»ç»Ÿå¥åº·çŠ¶æ€</h3>
            <div id="healthStatus">æ£€æŸ¥ä¸­...</div>
            <div class="btn-group">
              <button class="btn btn-primary" id="btnRefreshHealth">åˆ·æ–°çŠ¶æ€</button>
            </div>
          </div>
          
          <div class="card">
            <h3>ğŸ”§ æ¨¡å‹çŠ¶æ€</h3>
            <div id="modelStatus">åŠ è½½ä¸­...</div>
          </div>
        </div>
        
        <div class="card">
          <h3>ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡</h3>
          <div class="grid grid-3" id="performanceMetrics">
            <div class="metric-card">
              <div class="metric-value" id="totalRequests">0</div>
              <div class="metric-label">æ€»è¯·æ±‚æ•°</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="avgLatency">0ms</div>
              <div class="metric-label">å¹³å‡å»¶è¿Ÿ</div>
            </div>
            <div class="metric-card">
              <div class="metric-value" id="successRate">100%</div>
              <div class="metric-label">æˆåŠŸç‡</div>
            </div>
          </div>
        </div>
      </div>

      <!-- è®¾ç½® -->
      <div class="tab-pane" id="settings">
        <div class="card">
          <h3>âš™ï¸ æ¥å£è®¾ç½®</h3>
          <label>API Base URL</label>
          <input type="text" id="apiBaseUrl" value="" placeholder="http://localhost:8000" />
          
          <label>è®¤è¯Tokenï¼ˆå¦‚éœ€è¦ï¼‰</label>
          <input type="text" id="authToken" placeholder="Bearer your-token-here" />
          
          <div class="btn-group">
            <button class="btn btn-primary" id="btnSaveSettings">ä¿å­˜è®¾ç½®</button>
            <button class="btn btn-secondary" id="btnResetSettings">é‡ç½®</button>
          </div>
        </div>
        
        <div class="card">
          <h3>ğŸ¨ ç•Œé¢è®¾ç½®</h3>
          <label>ä¸»é¢˜æ¨¡å¼</label>
          <select id="themeMode">
            <option value="auto">è·Ÿéšç³»ç»Ÿ</option>
            <option value="light">æµ…è‰²æ¨¡å¼</option>
            <option value="dark">æ·±è‰²æ¨¡å¼</option>
          </select>
          
          <label>
            <input type="checkbox" id="autoRefresh" /> è‡ªåŠ¨åˆ·æ–°ç›‘æ§æ•°æ®
          </label>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€çŠ¶æ€
    const state = {
      apiBaseUrl: window.location.origin,
      authToken: '',
      stats: {
        totalRequests: 0,
        totalLatency: 0,
        successCount: 0
      }
    };

    // DOM å…ƒç´ 
    const elements = {
      // æ ‡ç­¾é¡µ
      tabs: document.querySelectorAll('.tab'),
      tabPanes: document.querySelectorAll('.tab-pane'),
      
      // å•æ–‡æœ¬æ¨ç†
      singleText: document.getElementById('singleText'),
      inferenceMode: document.getElementById('inferenceMode'),
      btnSingleInfer: document.getElementById('btnSingleInfer'),
      btnSingleClear: document.getElementById('btnSingleClear'),
      singleResult: document.getElementById('singleResult'),
      taskType: document.getElementById('taskType'),
      confidence: document.getElementById('confidence'),
      latency: document.getElementById('latency'),
      suggestions: document.getElementById('suggestions'),
      
      // æ‰¹é‡æ¨ç†
      batchTexts: document.getElementById('batchTexts'),
      batchMode: document.getElementById('batchMode'),
      batchFile: document.getElementById('batchFile'),
      btnBatchInfer: document.getElementById('btnBatchInfer'),
      btnBatchClear: document.getElementById('btnBatchClear'),
      btnExportResults: document.getElementById('btnExportResults'),
      batchProgress: document.getElementById('batchProgress'),
      batchStatus: document.getElementById('batchStatus'),
      batchResults: document.getElementById('batchResults'),
      
      // ç›‘æ§
      healthStatus: document.getElementById('healthStatus'),
      modelStatus: document.getElementById('modelStatus'),
      btnRefreshHealth: document.getElementById('btnRefreshHealth'),
      totalRequests: document.getElementById('totalRequests'),
      avgLatency: document.getElementById('avgLatency'),
      successRate: document.getElementById('successRate'),
      
      // è®¾ç½®
      apiBaseUrl: document.getElementById('apiBaseUrl'),
      authToken: document.getElementById('authToken'),
      btnSaveSettings: document.getElementById('btnSaveSettings'),
      btnResetSettings: document.getElementById('btnResetSettings'),
      themeMode: document.getElementById('themeMode'),
      autoRefresh: document.getElementById('autoRefresh')
    };

    // å·¥å…·å‡½æ•°
    function showLoading(button, show = true) {
      const loading = button.querySelector('.loading');
      if (loading) {
        loading.classList.toggle('hidden', !show);
      }
      button.disabled = show;
    }

    function updateStats(latency, success = true) {
      state.stats.totalRequests++;
      state.stats.totalLatency += latency;
      if (success) state.stats.successCount++;

      elements.totalRequests.textContent = state.stats.totalRequests;
      elements.avgLatency.textContent = Math.round(state.stats.totalLatency / state.stats.totalRequests) + 'ms';
      elements.successRate.textContent = Math.round((state.stats.successCount / state.stats.totalRequests) * 100) + '%';
    }

    async function apiRequest(endpoint, options = {}) {
      const url = `${state.apiBaseUrl}${endpoint}`;
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };

      if (state.authToken) {
        headers['Authorization'] = state.authToken;
      }

      const response = await fetch(url, {
        ...options,
        headers
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(`HTTP ${response.status}: ${error}`);
      }

      return response.json();
    }

    // æ ‡ç­¾é¡µåˆ‡æ¢
    elements.tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;

        // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
        elements.tabs.forEach(t => t.classList.remove('active'));
        elements.tabPanes.forEach(p => p.classList.remove('active'));

        tab.classList.add('active');
        document.getElementById(targetTab).classList.add('active');
      });
    });

    // å•æ–‡æœ¬æ¨ç†
    elements.btnSingleInfer.addEventListener('click', async () => {
      const text = elements.singleText.value.trim();
      if (!text) {
        alert('è¯·è¾“å…¥è¦åˆ†æçš„æ–‡æœ¬');
        return;
      }

      showLoading(elements.btnSingleInfer, true);
      elements.singleResult.textContent = 'æ¨ç†ä¸­...';
      elements.taskType.textContent = '-';
      elements.confidence.textContent = '-';
      elements.latency.textContent = '-';
      elements.suggestions.textContent = 'æ¨ç†ä¸­...';

      try {
        const mode = elements.inferenceMode.value;
        let endpoint = '/infer';
        if (mode === 'cloud') endpoint = '/infer/cloud';

        const result = await apiRequest(endpoint, {
          method: 'POST',
          body: JSON.stringify({ text })
        });

        // æ›´æ–°ç»“æœæ˜¾ç¤º
        elements.singleResult.textContent = JSON.stringify(result, null, 2);
        elements.taskType.textContent = result.task_type || '-';
        elements.confidence.textContent = result.confidence ? (result.confidence * 100).toFixed(1) + '%' : '-';
        elements.latency.textContent = result.latency_ms || '-';

        // æ›´æ–°å»ºè®®
        const suggestions = [];
        if (result.summary_text) suggestions.push(`ğŸ“ ${result.summary_text}`);
        if (result.suggested_plan) suggestions.push(`ğŸ’¡ ${result.suggested_plan}`);
        if (result.potential_omissions && result.potential_omissions.length > 0) {
          suggestions.push(`âš ï¸ å¯èƒ½é—æ¼ï¼š${result.potential_omissions.join('ã€')}`);
        }
        elements.suggestions.innerHTML = suggestions.join('<br><br>') || 'æš‚æ— å»ºè®®';

        updateStats(result.latency_ms || 0, true);

      } catch (error) {
        elements.singleResult.textContent = `æ¨ç†å¤±è´¥: ${error.message}`;
        elements.suggestions.textContent = 'æ¨ç†å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–ç½‘ç»œè¿æ¥';
        updateStats(0, false);
      } finally {
        showLoading(elements.btnSingleInfer, false);
      }
    });

    elements.btnSingleClear.addEventListener('click', () => {
      elements.singleText.value = '';
      elements.singleResult.textContent = 'ç­‰å¾…æ¨ç†ç»“æœ...';
      elements.taskType.textContent = '-';
      elements.confidence.textContent = '-';
      elements.latency.textContent = '-';
      elements.suggestions.textContent = 'ç­‰å¾…æ¨ç†ç»“æœ...';
    });

    // æ‰¹é‡æ¨ç†
    elements.batchFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const text = await file.text();
        if (file.name.endsWith('.json')) {
          const data = JSON.parse(text);
          if (Array.isArray(data)) {
            elements.batchTexts.value = data.join('\n');
          } else if (data.texts && Array.isArray(data.texts)) {
            elements.batchTexts.value = data.texts.join('\n');
          }
        } else {
          elements.batchTexts.value = text;
        }
      } catch (error) {
        alert(`æ–‡ä»¶è¯»å–å¤±è´¥: ${error.message}`);
      }
    });

    elements.btnBatchInfer.addEventListener('click', async () => {
      const textsInput = elements.batchTexts.value.trim();
      if (!textsInput) {
        alert('è¯·è¾“å…¥è¦æ‰¹é‡åˆ†æçš„æ–‡æœ¬');
        return;
      }

      const texts = textsInput.split('\n').filter(t => t.trim()).map(t => t.trim());
      if (texts.length === 0) {
        alert('æ²¡æœ‰æœ‰æ•ˆçš„æ–‡æœ¬è¡Œ');
        return;
      }

      if (texts.length > 100) {
        alert('æ‰¹é‡æ¨ç†æœ€å¤šæ”¯æŒ100ä¸ªæ–‡æœ¬');
        return;
      }

      showLoading(elements.btnBatchInfer, true);
      elements.batchProgress.style.width = '0%';
      elements.batchStatus.textContent = `å‡†å¤‡å¤„ç† ${texts.length} ä¸ªæ–‡æœ¬...`;
      elements.batchResults.innerHTML = '';

      try {
        const mode = elements.batchMode.value;
        const useCloud = mode === 'cloud' ? true : mode === 'external' ? false : null;

        const result = await apiRequest('/infer/batch', {
          method: 'POST',
          body: JSON.stringify({
            texts,
            use_cloud_inference: useCloud
          })
        });

        // æ›´æ–°è¿›åº¦
        elements.batchProgress.style.width = '100%';
        elements.batchStatus.textContent = `å®Œæˆï¼æˆåŠŸ ${result.success_count}/${result.total_count}ï¼Œæ€»è€—æ—¶ ${result.total_latency_ms}ms`;

        // æ˜¾ç¤ºç»“æœ
        const resultsHtml = result.results.map((r, i) => {
          const isSuccess = r.confidence > 0.1 && r.task_type !== 'other';
          return `
            <div class="batch-item ${isSuccess ? 'success' : 'error'}">
              <strong>æ–‡æœ¬ ${i + 1}:</strong> ${texts[i]}<br>
              <strong>ä»»åŠ¡ç±»å‹:</strong> ${r.task_type}
              <strong>ç½®ä¿¡åº¦:</strong> ${(r.confidence * 100).toFixed(1)}%
              <strong>è€—æ—¶:</strong> ${r.latency_ms}ms<br>
              <strong>æ‘˜è¦:</strong> ${r.summary_text}<br>
              <strong>å»ºè®®:</strong> ${r.suggested_plan}
              ${r.potential_omissions && r.potential_omissions.length > 0 ?
                `<br><strong>å¯èƒ½é—æ¼:</strong> ${r.potential_omissions.join('ã€')}` : ''}
            </div>
          `;
        }).join('');

        elements.batchResults.innerHTML = resultsHtml;

        // ä¿å­˜ç»“æœç”¨äºå¯¼å‡º
        window.lastBatchResults = { texts, results: result.results };

        updateStats(result.total_latency_ms / result.total_count, result.success_count > 0);

      } catch (error) {
        elements.batchStatus.textContent = `æ‰¹é‡æ¨ç†å¤±è´¥: ${error.message}`;
        elements.batchResults.innerHTML = `<div class="batch-item error">é”™è¯¯: ${error.message}</div>`;
        updateStats(0, false);
      } finally {
        showLoading(elements.btnBatchInfer, false);
      }
    });

    elements.btnBatchClear.addEventListener('click', () => {
      elements.batchTexts.value = '';
      elements.batchFile.value = '';
      elements.batchProgress.style.width = '0%';
      elements.batchStatus.textContent = 'å‡†å¤‡å°±ç»ª';
      elements.batchResults.innerHTML = 'ç­‰å¾…æ‰¹é‡æ¨ç†...';
    });

    elements.btnExportResults.addEventListener('click', () => {
      if (!window.lastBatchResults) {
        alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
        return;
      }

      const data = {
        timestamp: new Date().toISOString(),
        total_count: window.lastBatchResults.results.length,
        results: window.lastBatchResults.texts.map((text, i) => ({
          input_text: text,
          ...window.lastBatchResults.results[i]
        }))
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `pulseweave_batch_results_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ç³»ç»Ÿç›‘æ§
    async function refreshHealth() {
      showLoading(elements.btnRefreshHealth, true);

      try {
        const health = await apiRequest('/model/health');

        let statusHtml = '';
        const overallStatus = health.overall_status;
        const statusClass = overallStatus === 'healthy' ? 'status-healthy' :
                           overallStatus === 'degraded' ? 'status-warning' : 'status-error';

        statusHtml += `<div><span class="status-indicator ${statusClass}"></span><strong>æ€»ä½“çŠ¶æ€:</strong> ${overallStatus}</div><br>`;

        if (health.cloud_inference) {
          const cloudStatus = health.cloud_inference.status === 'healthy' ? 'status-healthy' : 'status-error';
          statusHtml += `<div><span class="status-indicator ${cloudStatus}"></span><strong>äº‘ç«¯æ¨ç†:</strong> ${health.cloud_inference.status}</div>`;
          if (health.cloud_inference.latency_ms) {
            statusHtml += ` (${health.cloud_inference.latency_ms}ms)`;
          }
          statusHtml += '<br>';
        }

        if (health.external_provider) {
          const providerStatus = health.external_provider.status === 'healthy' ? 'status-healthy' : 'status-error';
          statusHtml += `<div><span class="status-indicator ${providerStatus}"></span><strong>å¤–éƒ¨æä¾›å•†:</strong> ${health.external_provider.status}</div>`;
          if (health.external_provider.latency_ms) {
            statusHtml += ` (${health.external_provider.latency_ms}ms)`;
          }
        }

        elements.healthStatus.innerHTML = statusHtml;

      } catch (error) {
        elements.healthStatus.innerHTML = `<div><span class="status-indicator status-error"></span>å¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
      } finally {
        showLoading(elements.btnRefreshHealth, false);
      }
    }

    async function refreshModelStatus() {
      try {
        const status = await apiRequest('/model/status');

        let statusHtml = '';

        if (status.cloud_inference) {
          statusHtml += '<h4>ğŸŒ¥ï¸ äº‘ç«¯æ¨ç†</h4>';
          statusHtml += `<p><strong>åˆå§‹åŒ–çŠ¶æ€:</strong> ${status.cloud_inference.initialized ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'}</p>`;
          statusHtml += `<p><strong>è®¾å¤‡:</strong> ${status.cloud_inference.device || 'unknown'}</p>`;
          statusHtml += `<p><strong>å·²åŠ è½½æ¨¡å‹:</strong> ${status.cloud_inference.loaded_models ? status.cloud_inference.loaded_models.join(', ') : 'æ— '}</p>`;
          statusHtml += `<p><strong>æ”¯æŒä»»åŠ¡ç±»å‹:</strong> ${status.cloud_inference.available_task_types ? status.cloud_inference.available_task_types.join(', ') : 'æ— '}</p>`;
        }

        if (status.external_provider) {
          statusHtml += '<h4>ğŸ”— å¤–éƒ¨æä¾›å•†</h4>';
          statusHtml += `<p><strong>æä¾›å•†:</strong> ${status.external_provider.name}</p>`;
          statusHtml += `<p><strong>æ¨¡å‹:</strong> ${status.external_provider.model}</p>`;
          statusHtml += `<p><strong>çŠ¶æ€:</strong> ${status.external_provider.available ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}</p>`;
        }

        if (status.service_config) {
          statusHtml += '<h4>âš™ï¸ æœåŠ¡é…ç½®</h4>';
          statusHtml += `<p><strong>éœ€è¦è®¤è¯:</strong> ${status.service_config.require_auth ? 'æ˜¯' : 'å¦'}</p>`;
          statusHtml += `<p><strong>è¿”å›å‘é‡:</strong> ${status.service_config.return_vector ? 'æ˜¯' : 'å¦'}</p>`;
        }

        elements.modelStatus.innerHTML = statusHtml;

      } catch (error) {
        elements.modelStatus.innerHTML = `æ¨¡å‹çŠ¶æ€è·å–å¤±è´¥: ${error.message}`;
      }
    }

    elements.btnRefreshHealth.addEventListener('click', () => {
      refreshHealth();
      refreshModelStatus();
    });

    // è®¾ç½®åŠŸèƒ½
    function loadSettings() {
      const savedSettings = localStorage.getItem('pulseweave_settings');
      if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        state.apiBaseUrl = settings.apiBaseUrl || window.location.origin;
        state.authToken = settings.authToken || '';

        elements.apiBaseUrl.value = state.apiBaseUrl;
        elements.authToken.value = state.authToken;
        elements.themeMode.value = settings.themeMode || 'auto';
        elements.autoRefresh.checked = settings.autoRefresh || false;
      } else {
        elements.apiBaseUrl.value = window.location.origin;
      }
    }

    function saveSettings() {
      const settings = {
        apiBaseUrl: elements.apiBaseUrl.value.trim() || window.location.origin,
        authToken: elements.authToken.value.trim(),
        themeMode: elements.themeMode.value,
        autoRefresh: elements.autoRefresh.checked
      };

      state.apiBaseUrl = settings.apiBaseUrl;
      state.authToken = settings.authToken;

      localStorage.setItem('pulseweave_settings', JSON.stringify(settings));
      alert('è®¾ç½®å·²ä¿å­˜');
    }

    elements.btnSaveSettings.addEventListener('click', saveSettings);

    elements.btnResetSettings.addEventListener('click', () => {
      if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿ')) {
        localStorage.removeItem('pulseweave_settings');
        elements.apiBaseUrl.value = window.location.origin;
        elements.authToken.value = '';
        elements.themeMode.value = 'auto';
        elements.autoRefresh.checked = false;

        state.apiBaseUrl = window.location.origin;
        state.authToken = '';

        alert('è®¾ç½®å·²é‡ç½®');
      }
    });

    // è‡ªåŠ¨åˆ·æ–°
    let autoRefreshInterval;

    elements.autoRefresh.addEventListener('change', () => {
      if (elements.autoRefresh.checked) {
        autoRefreshInterval = setInterval(() => {
          if (document.getElementById('monitor').classList.contains('active')) {
            refreshHealth();
            refreshModelStatus();
          }
        }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
      } else {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      }
    });

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();

      // åˆå§‹åŠ è½½ç›‘æ§æ•°æ®
      setTimeout(() => {
        refreshHealth();
        refreshModelStatus();
      }, 1000);

      // æ·»åŠ ä¸€äº›ç¤ºä¾‹æ–‡æœ¬
      const examples = [
        "æ˜æ—©ä¸ƒç‚¹å»æœºåœºï¼Œè®°å¾—èº«ä»½è¯å’Œå……ç”µå®",
        "ä¸‹å‘¨ä¸‰ä¸‹åˆä¸¤ç‚¹å¼€é¡¹ç›®è¯„å®¡ä¼š",
        "å‘¨æœ«å»è¶…å¸‚ä¹°èœï¼Œéœ€è¦ä¹°ç±³ã€æ²¹ã€è”¬èœ",
        "æ˜å¤©ä½“æ£€ï¼Œæ—©ä¸Šä¸èƒ½åƒä¸œè¥¿",
        "æ™šä¸Šå’Œæœ‹å‹èšé¤ï¼Œè®¢ä¸ªåŒ…é—´"
      ];

      // éšæœºé€‰æ‹©ä¸€ä¸ªç¤ºä¾‹
      const randomExample = examples[Math.floor(Math.random() * examples.length)];
      elements.singleText.placeholder = randomExample;
    });

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
          case 'Enter':
            e.preventDefault();
            if (document.getElementById('single').classList.contains('active')) {
              elements.btnSingleInfer.click();
            } else if (document.getElementById('batch').classList.contains('active')) {
              elements.btnBatchInfer.click();
            }
            break;
          case '1':
            e.preventDefault();
            elements.tabs[0].click();
            break;
          case '2':
            e.preventDefault();
            elements.tabs[1].click();
            break;
          case '3':
            e.preventDefault();
            elements.tabs[2].click();
            break;
          case '4':
            e.preventDefault();
            elements.tabs[3].click();
            break;
        }
      }
    });
  </script>
</body>
</html>
