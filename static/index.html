<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PulseWeave ç½‘å…³ Â· å¯è§†åŒ–ç•Œé¢</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif; margin: 0; padding: 24px; }
    .container { max-width: 880px; margin: 0 auto; }
    h1 { font-size: 22px; margin: 0 0 12px; }
    .card { background: rgba(0,0,0,0.04); padding: 16px; border-radius: 10px; margin-bottom: 16px; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    input[type="text"], textarea { width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.15); background: rgba(255,255,255,0.9); }
    textarea { min-height: 120px; resize: vertical; }
    button { padding: 10px 14px; border: none; border-radius: 8px; background: #2563eb; color: #fff; cursor: pointer; font-weight: 600; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .result { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: #0b1021; color: #e2e8f0; padding: 12px; border-radius: 8px; overflow: auto; }
    .muted { color: #666; font-size: 12px; }
    .footer { margin-top: 24px; color: #777; font-size: 12px; }
    .cols { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .plain { background: rgba(255,255,255,0.75); color: #111; border-radius: 8px; padding: 12px; border: 1px solid rgba(0,0,0,0.1); white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="container">
    <h1>PulseWeave API Gateway Â· å¯è§†åŒ–ç•Œé¢</h1>

    <div style="margin-bottom: 20px; padding: 15px; background-color: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
      <h3 style="margin-top: 0; color: #1976d2;">ğŸ”„ WebSocketå®æ—¶æ¨ç†</h3>
      <p style="margin-bottom: 10px;">æ”¯æŒå¼‚æ­¥æ¨ç†å’Œå®æ—¶çŠ¶æ€é€šçŸ¥ï¼Œé€‚åˆé•¿æ—¶é—´æ¨ç†ä»»åŠ¡</p>
      <a href="websocket_demo.html" style="color: #1976d2; text-decoration: none; font-weight: bold;">
        â†’ ä½“éªŒWebSocketæ¼”ç¤ºç•Œé¢
      </a>
    </div>

    <div class="card">
      <label>è¾“å…¥æ–‡æœ¬</label>
      <textarea id="inputText" placeholder="ä¾‹å¦‚ï¼šæ˜æ—©ä¸ƒç‚¹å»æœºåœºï¼Œè®°å¾—èº«ä»½è¯å’Œå……ç”µå®"></textarea>
      <div style="margin-top:12px; display:flex; gap:8px;">
        <button id="btnInfer">å‘é€æ¨ç†</button>
        <button id="btnHealth" style="background:#16a34a;">å¥åº·æ£€æŸ¥</button>
        <button id="btnClear" style="background:#64748b;">æ¸…ç©º</button>
      </div>
    </div>

    <div class="card cols">
      <div>
        <label>çº¯æ–‡å­—ç»“æœ</label>
        <div id="summary" class="plain">ç­‰å¾…è¯·æ±‚â€¦</div>
      </div>
      <div>
        <label>å»ºè®®è§„åˆ’</label>
        <div id="plan" class="plain">ç­‰å¾…è¯·æ±‚â€¦</div>
      </div>
    </div>

    <div class="card">
      <label>åŸå§‹è¿”å›ï¼ˆè°ƒè¯•ç”¨ï¼‰</label>
      <pre id="result" class="result">ç­‰å¾…è¯·æ±‚â€¦</pre>
      <p class="muted">ç”¨äºè°ƒè¯•æŸ¥çœ‹å®Œæ•´JSONï¼Œæ­£å¸¸ä½¿ç”¨ä»¥â€œçº¯æ–‡å­—ç»“æœ/å»ºè®®è§„åˆ’â€ä¸ºå‡†ã€‚</p>
    </div>

    <div class="footer">Â© PulseWeave</div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function setLoading(loading) {
      $("btnInfer").disabled = loading;
      $("btnHealth").disabled = loading;
    }

    async function doHealth() {
      setLoading(true);
      $("result").textContent = "å¥åº·æ£€æŸ¥ä¸­â€¦";
      try {
        const resp = await fetch("/health", { method: "GET" });
        const data = await resp.json();
        $("result").textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        $("result").textContent = String(e);
      } finally {
        setLoading(false);
      }
    }

    async function doInfer() {
      const text = $("inputText").value.trim();
      if (!text) {
        $("result").textContent = "è¯·è¾“å…¥æ–‡æœ¬";
        return;
      }
      setLoading(true);
      $("result").textContent = "æ¨ç†ä¸­â€¦";
      $("summary").textContent = "æ¨ç†ä¸­â€¦";
      $("plan").textContent = "æ¨ç†ä¸­â€¦";
      try {
        // ä½¿ç”¨DeepSeek APIè¿›è¡Œæ¨ç†
        let resp = await fetch("/infer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });

        if (!resp.ok) {
          const errorText = await resp.text();
          throw new Error(`æ¨ç†å¤±è´¥: HTTP ${resp.status}: ${errorText}`);
        }

        const data = await resp.json();
        $("result").textContent = JSON.stringify(data, null, 2);
        $("summary").textContent = data.summary_text || "(æ— æ‘˜è¦)";
        $("plan").textContent = data.suggested_plan || "(æ— å»ºè®®)";

        // æ˜¾ç¤ºå¢å¼ºä¿¡æ¯
        displayEnhancedInfo(data);
      } catch (e) {
        $("result").textContent = String(e);
        $("summary").textContent = "è¯·æ±‚å¤±è´¥";
        $("plan").textContent = "è¯·æ±‚å¤±è´¥";
      } finally {
        setLoading(false);
      }
    }

    $("btnHealth").addEventListener("click", doHealth);
    $("btnInfer").addEventListener("click", doInfer);
    $("btnClear").addEventListener("click", () => { 
      $("inputText").value = ""; 
      $("result").textContent = "å·²æ¸…ç©º"; 
      $("summary").textContent = "ç­‰å¾…è¯·æ±‚â€¦";
      $("plan").textContent = "ç­‰å¾…è¯·æ±‚â€¦";
    });

    // æ˜¾ç¤ºå¢å¼ºä¿¡æ¯çš„å‡½æ•°
    function displayEnhancedInfo(data) {
      let enhancedHtml = "";

      // æ˜¾ç¤ºæå–çš„å®ä½“
      if (data.extracted_entities && data.extracted_entities.length > 0) {
        enhancedHtml += "<h4>ğŸ·ï¸ æå–çš„å®ä½“:</h4><ul>";
        data.extracted_entities.forEach(entity => {
          enhancedHtml += `<li>${entity.type}: ${entity.value} (${(entity.confidence * 100).toFixed(1)}%)</li>`;
        });
        enhancedHtml += "</ul>";
      }

      // æ˜¾ç¤ºå»ºè®®æ ‡ç­¾
      if (data.suggested_tags && data.suggested_tags.length > 0) {
        enhancedHtml += "<h4>ğŸ·ï¸ å»ºè®®æ ‡ç­¾:</h4><p>";
        data.suggested_tags.forEach(tag => {
          enhancedHtml += `<span style="background:#e3f2fd;padding:2px 6px;margin:2px;border-radius:3px;">${tag}</span> `;
        });
        enhancedHtml += "</p>";
      }

      // æ˜¾ç¤ºä¼˜å…ˆçº§
      if (data.priority_level) {
        const priorityColors = {high: "#f44336", medium: "#ff9800", low: "#4caf50"};
        const color = priorityColors[data.priority_level] || "#666";
        enhancedHtml += `<h4>âš¡ ä¼˜å…ˆçº§: <span style="color:${color}">${data.priority_level}</span></h4>`;
      }

      // æ˜¾ç¤ºæé†’å»ºè®®
      if (data.reminder_suggestions && data.reminder_suggestions.length > 0) {
        enhancedHtml += "<h4>â° æé†’å»ºè®®:</h4><ul>";
        data.reminder_suggestions.forEach(reminder => {
          enhancedHtml += `<li>${reminder}</li>`;
        });
        enhancedHtml += "</ul>";
      }

      // æ˜¾ç¤ºäº‹ä»¶åˆ†æï¼ˆå¦‚æœæœ‰ï¼‰
      if (data.event_analysis) {
        enhancedHtml += "<h4>ğŸ“Š äº‹ä»¶åˆ†æ:</h4><ul>";
        const analysis = data.event_analysis;
        if (analysis.speaker_count > 0) {
          enhancedHtml += `<li>è¯´è¯äººæ•°é‡: ${analysis.speaker_count}</li>`;
        }
        if (analysis.event_duration_sec > 0) {
          enhancedHtml += `<li>äº‹ä»¶æ—¶é•¿: ${analysis.event_duration_sec.toFixed(1)} ç§’</li>`;
        }
        if (analysis.contains_pii) {
          enhancedHtml += `<li>âš ï¸ åŒ…å«ä¸ªäººæ•æ„Ÿä¿¡æ¯</li>`;
        }
        enhancedHtml += "</ul>";
      }

      // æ˜¾ç¤ºéŸ³é¢‘è´¨é‡ï¼ˆå¦‚æœæœ‰ï¼‰
      if (data.audio_quality_assessment) {
        const quality = data.audio_quality_assessment;
        const qualityColors = {good: "#4caf50", fair: "#ff9800", poor: "#f44336"};
        const color = qualityColors[quality.overall_quality] || "#666";
        enhancedHtml += `<h4>ğŸµ éŸ³é¢‘è´¨é‡: <span style="color:${color}">${quality.overall_quality}</span></h4>`;
        if (quality.asr_confidence) {
          enhancedHtml += `<p>ASRç½®ä¿¡åº¦: ${(quality.asr_confidence * 100).toFixed(1)}%</p>`;
        }
      }

      // å¦‚æœæœ‰å¢å¼ºä¿¡æ¯ï¼Œæ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
      if (enhancedHtml) {
        let enhancedDiv = document.getElementById("enhanced-info");
        if (!enhancedDiv) {
          enhancedDiv = document.createElement("div");
          enhancedDiv.id = "enhanced-info";
          enhancedDiv.style.marginTop = "20px";
          enhancedDiv.style.padding = "15px";
          enhancedDiv.style.backgroundColor = "#f8f9fa";
          enhancedDiv.style.borderRadius = "8px";
          enhancedDiv.style.border = "1px solid #dee2e6";
          document.querySelector(".container").appendChild(enhancedDiv);
        }
        enhancedDiv.innerHTML = "<h3>ğŸ” å¢å¼ºåˆ†æç»“æœ</h3>" + enhancedHtml;
      }
    }
  </script>
</body>
</html>